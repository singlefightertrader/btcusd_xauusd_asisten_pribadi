<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER ASSISTANT · CONTRACT VALID</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
body{margin:0;background:#000;color:#00ff99;font-family:Consolas,monospace}
#top{padding:8px;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center}
select,button,input{background:#111;color:#fff;border:1px solid #444;padding:6px;font-family:Consolas}
button.active{background:#00ff99;color:#000}
#status{font-weight:bold}

#chartWrap{position:relative}
#tv{width:100%;height:40vh;border:none}
#overlay{
  position:absolute;top:0;left:0;right:0;bottom:0;
  pointer-events:none;
}
.mline{position:absolute;left:0;right:0;height:1px;opacity:.9}
.m15{background:#ffff00}
.m30{background:#00bfff}
.m1h{background:#bf00ff}

#panel{height:60vh;overflow:auto;padding:8px}
.section{border:1px solid #333;margin-bottom:8px;padding:8px;background:#070707}

#decision{display:flex;gap:8px}
#decision button{flex:1;font-size:16px;font-weight:bold}
.wait{border:2px solid #555}
.standby{border:2px solid #ffaa00;animation:blink 1.2s infinite}
.gas{border:2px solid #00ff99}
.late{border:2px solid #ff4444}

@keyframes blink{50%{box-shadow:0 0 10px rgba(255,170,0,.6)}}

#reason{display:none;border-left:4px solid #ffaa00;padding:8px;white-space:pre-line}
</style>
</head>

<body>

<div id="top">
<b>PAIR</b>
<select id="pair">
<option>BTCUSDT</option>
<option>XAUUSD</option>
</select>
<b id="status">BOOT</b>
<button id="toggleReason">SHOW</button>
<button id="toggleLines">MISSION LINES</button>
</div>

<div id="chartWrap">
<iframe id="tv"></iframe>
<div id="overlay"></div>
</div>

<div id="panel">

<div class="section">
<b>ANCHOR H1 (MANUAL OHLC)</b><br>
O <input id="o" size="7">
H <input id="h" size="7">
L <input id="l" size="7">
C <input id="c" size="7">
<button id="setAnchor">SET</button>
</div>

<div class="section">
<b>DECISION</b>
<div id="decision">
<button id="buy">BUY</button>
<button id="sell">SELL</button>
</div>
</div>

<div id="reason"></div>

</div>

<script>
/* ================= STATE ================= */
const TF=["1m","5m","15m","30m","1h"];
const KEY="SCALPER_CONTRACT_VALID";
let STATE=JSON.parse(localStorage.getItem(KEY)||"{}");
function init(){return{price:null,anchor:null,anchorState:"NONE",tf:{}}}
["BTCUSDT","XAUUSD"].forEach(p=>{
 if(!STATE[p])STATE[p]=init();
 TF.forEach(tf=>{
  if(!STATE[p].tf[tf])STATE[p].tf[tf]={last:null,prev:null,missions:[]};
 });
});
function save(){localStorage.setItem(KEY,JSON.stringify(STATE))}

/* ================= ANCHOR ================= */
const MAX=1000*60*60*4;
function updateAnchor(p){
 if(!p.anchor){p.anchorState="NONE";return}
 let age=Date.now()-p.anchor.t;
 if(p.anchor.bad)p.anchorState="INVALID";
 else if(age>MAX)p.anchorState="EXPIRED";
 else if(age>MAX*0.6)p.anchorState="SUSPECT";
 else p.anchorState="OK";
}

/* ================= MISSIONS ================= */
function createMission(d){
 if(d.prev===null)return;
 d.missions.push({
  price:d.prev,
  role:["15m","30m","1h"].includes(d.tf)?"CONTEXT":"TARGET",
  status:"ACTIVE"
 });
}
function updateMission(d,close){
 d.missions.forEach(m=>{
  if(m.status==="ACTIVE"){
   if(close===m.price)m.status="CONSUMED";
   else if(m.role==="CONTEXT")m.status="CONTEXT";
   else m.status="WAITING";
  }
 });
 d.missions=d.missions.filter(m=>m.status!=="CONSUMED");
}

/* ================= BTC WS ================= */
let ws;
function connect(){
 ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+TF.map(t=>"btcusdt@kline_"+t).join("/"));
 ws.onmessage=e=>{
  let k=JSON.parse(e.data).data.k;if(!k.x)return;
  let p=STATE.BTCUSDT,d=p.tf[k.i];
  d.tf=k.i;d.prev=d.last;d.last=+k.c;p.price=+k.c;
  createMission(d);updateMission(d,+k.c);updateAnchor(p);
  save();render();
 };
}
connect();setInterval(()=>{if(!ws||ws.readyState>1)connect()},5000);

/* ================= XAU LOOP ================= */
setInterval(()=>{
 let p=STATE.XAUUSD;if(!p.anchor)return;
 TF.forEach(tf=>{
  let d=p.tf[tf];d.tf=tf;d.prev=d.last;d.last=p.anchor.C;
  createMission(d);updateMission(d,p.anchor.C);
 });
 p.price=p.anchor.C;updateAnchor(p);save();render();
},60000);

/* ================= DECISION ================= */
function decisionState(p){
 let m1=p.tf["1m"].missions[0],m5=p.tf["5m"].missions[0];
 if(!m1||!m5)return"WAIT";
 let min=Math.min(m1.price,m5.price),max=Math.max(m1.price,m5.price);
 if(p.price>min&&p.price<max)return"GAS";
 if(Math.abs(p.price-(min+max)/2)<(max-min)*2)return"STANDBY";
 return"LATE";
}

function decide(dir){
 let p=STATE[pair.value];updateAnchor(p);
 buy.classList.remove("active");sell.classList.remove("active");
 this.classList.add("active");

 reason.textContent="";
 if(p.anchorState!=="OK"){status.textContent="WAIT · ANCHOR";return}

 let s=decisionState(p);
 decision.className=s.toLowerCase();
 status.textContent=s+" "+dir;

 let ctx=[];
 ["15m","30m","1h"].forEach(tf=>{
  let m=p.tf[tf].missions[0];
  if(m&&m.role==="CONTEXT")ctx.push(tf.toUpperCase()+" CONTEXT");
 });
 reason.textContent=ctx.length
  ? "KONTEKS AKTIF:\n"+ctx.join(", ")
  : "EKSEKUSI M1–M5 SAJA";

 if(s==="GAS")gasSound();
}

/* ================= SOUND ================= */
const AC=new(window.AudioContext||window.webkitAudioContext)();
function gasSound(){
 let i=0,t=setInterval(()=>{
  let o=AC.createOscillator(),g=AC.createGain();
  o.frequency.value=1000;g.gain.value=.08;
  o.connect(g);g.connect(AC.destination);
  o.start();o.stop(AC.currentTime+.12);
  if(++i===4)clearInterval(t);
 },180);
}

/* ================= MISSION LINES ================= */
let showLines=true;
toggleLines.onclick=()=>{showLines=!showLines;overlay.style.display=showLines?"block":"none"}

function priceToY(price){
 let p=STATE[pair.value];
 let prices=["1m","5m","15m"].map(tf=>p.tf[tf].last).filter(v=>v);
 if(prices.length<2)return null;
 let min=Math.min(...prices),max=Math.max(...prices);
 let h=overlay.clientHeight;
 return h-((price-min)/(max-min))*h;
}

function renderLines(){
 overlay.innerHTML="";
 if(!showLines)return;
 let p=STATE[pair.value];
 ["15m","30m","1h"].forEach(tf=>{
  p.tf[tf].missions.forEach(m=>{
   if(m.status==="CONTEXT"){
    let y=priceToY(m.price);if(y===null)return;
    let d=document.createElement("div");
    d.className="mline "+(tf==="15m"?"m15":tf==="30m"?"m30":"m1h");
    d.style.top=y+"px";overlay.appendChild(d);
   }
  });
 });
}

/* ================= UI ================= */
buy.onclick=decide.bind(buy,"BUY");
sell.onclick=decide.bind(sell,"SELL");
toggleReason.onclick=()=>{reason.style.display=reason.style.display==="block"?"none":"block"};

setAnchor.onclick=()=>{
 let O=+o.value,H=+h.value,L=+l.value,C=+c.value;
 let p=STATE[pair.value];
 if(H<Math.max(O,C)||L>Math.min(O,C)||O===C)p.anchor={bad:true,t:Date.now()};
 else p.anchor={O,H,L,C,t:Date.now()};
 updateAnchor(p);save();render();
};

function render(){
 let p=STATE[pair.value];
 status.textContent=pair.value+" · "+p.anchorState;
 renderLines();
}

function loadChart(){
 let sym=pair.value==="BTCUSDT"?"BINANCE:BTCUSDT":"OANDA:XAUUSD";
 tv.src=`https://s.tradingview.com/widgetembed/?symbol=${sym}&interval=60&theme=dark&timezone=Etc/UTC`;
}
pair.onchange=()=>{loadChart();render()};
loadChart();render();
</script>

</body>
</html>
