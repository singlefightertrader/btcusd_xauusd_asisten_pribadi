<!--
=====================================================================
FEATURE MANIFEST — SCALPER ASSISTANT (CONTRACT LOCK · FINAL)
=====================================================================

PAIR
- BTCUSDT
  • Market data: Binance WebSocket (CANDLE CLOSE)
- XAUUSD
  • Market data: Proxy visual (TradingView)
  • Logic price & mission: OHLC MANUAL

CORE SYSTEM
- Single-file HTML
- Loop aktif nonstop:
  • Binance WebSocket
  • Watchdog auto-reconnect
- Persistent state (localStorage) → refresh TIDAK reset
- Semua keputusan berbasis CANDLE CLOSE
- Timestamp referensi UTC

TIMEFRAME
- Aktif: M1, M5, M15, M30, H1

MASTER TF & ANCHOR
- MASTER TF = H1 (DIKUNCI)
- OHLC MANUAL DEFAULT = H1
- Anchor lifecycle:
  • OK
  • SUSPECT (anchor mulai tua)
  • EXPIRED (anchor kedaluwarsa)
  • INVALID (input salah)
- Anchor = otoritas tertinggi
- Anchor INVALID / EXPIRED → SEMUA ENTRY DITAHAN

VALIDASI OHLC
- High ≥ max(Open, Close)
- Low ≤ min(Open, Close)
- Body ≠ 0
- Wick TIDAK membatalkan misi
- Input salah → DITOLAK

MISSION PRICE ENGINE
- Misi harga tersedia di SEMUA TF (M1–H1)
- Multi-mission per TF (tidak overwrite)
- Misi dibuat dari CLOSE candle
- Misi TIDAK dihapus sampai ada CLOSE di level tersebut
- Status misi:
  • ACTIVE
  • WAITING
  • CONTEXT

CROSS TF CONTEXT
- TF boleh konflik
- Asisten MENJELASKAN konflik (bahasa trader lapangan)
- Tidak memaksa entry lintas TF

VISUAL OVERLAY
- Garis bantu misi:
  • DITAMPILKAN: M15 / M30 / H1
  • TIDAK ditampilkan: M1 / M5
- Entry Zone Area:
  • Muncul HANYA saat status = GAS
  • Dihitung dari anchor + mission TF terkait
  • Hilang saat TUNGGU / anchor tidak sehat

ASISTEN SCALPER & UI
- Tombol BUY & SELL
- Respon BUY ≠ SELL
- Status: GAS / TUNGGU (tidak bengong)
- Bahasa trader lapangan (jelaskan TF & konflik)
- SHOW / HIDE alasan
- Sound “tiiit tiiit” 4x saat GAS

PSIKOLOGI & KEAMANAN
- Lebih baik TUNGGU daripada entry salah
- Tidak maksa entry
- Tidak sinyal palsu
- Tidak auto-entry

KETENTUAN
- ADD ONLY
- Tidak ada fitur dihapus
- Jika 1 fitur di atas tidak ada → FILE INI CACAT
=====================================================================
END FEATURE MANIFEST
=====================================================================
-->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SCALPER ASSISTANT FINAL · BTCUSDT & XAUUSD</title>
<style>
*{box-sizing:border-box}
body{margin:0;background:#000;color:#00ff99;font-family:Consolas,monospace}
#top{display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px solid #222}
select,button,input{background:#111;color:#fff;border:1px solid #444;padding:6px;font-family:Consolas;font-size:12px}
#status{font-weight:bold}
#tvWrap{position:relative;height:45vh}
#tv{width:100%;height:100%;border:none}
#overlay{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
.line{position:absolute;height:1px;background:rgba(255,215,0,.7)}
.zone{position:absolute;left:0;right:0;background:rgba(0,255,255,.15);border:1px solid rgba(0,255,255,.6)}
#panel{height:55vh;overflow:auto;padding:8px}
.section{border:1px solid #333;background:#070707;padding:8px;margin-bottom:8px}
.buy{color:#00ff99}.sell{color:#ff5555}
.wait{color:#ffaa00}.ok{color:#00ff99}.bad{color:#ff4444}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border-bottom:1px solid #222;padding:4px}
#reason{display:none;border-left:4px solid #ffaa00;background:#0a0a0a;padding:8px;white-space:pre-line}
</style>
</head>
<body>

<div id="top">
<b>PAIR</b>
<select id="pair"><option>BTCUSDT</option><option>XAUUSD</option></select>
<b id="status">INIT</b>
<button id="toggleReason">SHOW</button>
</div>

<div id="tvWrap">
<iframe id="tv"></iframe>
<div id="overlay"></div>
</div>

<div id="panel">

<div class="section">
<b>OHLC MANUAL · MASTER TF H1</b><br/>
O <input id="o" size="7">
H <input id="h" size="7">
L <input id="l" size="7">
C <input id="c" size="7">
<button id="setAnchor">SET</button>
<div id="anchorState" class="wait"></div>
</div>

<div class="section">
<b>MISSION PRICE · SEMUA TF</b>
<table>
<thead><tr><th>TF</th><th>Misi</th><th>Bias</th><th>Status</th></tr></thead>
<tbody id="missions"></tbody>
</table>
</div>

<div class="section">
<button id="buy">BUY</button>
<button id="sell">SELL</button>
</div>

<div id="reason"></div>
</div>

<script>
/* ================= SOUND ================= */
const AC=new (window.AudioContext||window.webkitAudioContext)();
function gasSound(){
 let i=0,t=setInterval(()=>{
  let o=AC.createOscillator(),g=AC.createGain();
  o.frequency.value=1000;g.gain.value=.08;
  o.connect(g);g.connect(AC.destination);
  o.start();o.stop(AC.currentTime+.12);
  if(++i===4)clearInterval(t);
 },180);
}

/* ================= STATE ================= */
const TF=["1m","5m","15m","30m","1h"];
const KEY="SCALPER_FINAL_CORE_V2";
let S=JSON.parse(localStorage.getItem(KEY)||"{}");
function initPair(){return{price:0,anchor:null,anchorState:"NONE",offset:0,tf:{}}}
if(!S.BTCUSDT)S.BTCUSDT=initPair();
if(!S.XAUUSD)S.XAUUSD=initPair();
TF.forEach(tf=>{
 if(!S.BTCUSDT.tf[tf])S.BTCUSDT.tf[tf]={last:null,missions:[]};
 if(!S.XAUUSD.tf[tf])S.XAUUSD.tf[tf]={last:null,missions:[]};
});
const pairSel=document.getElementById("pair");

/* ================= CHART ================= */
function loadChart(){
 const p=pairSel.value;
 const sym=p==="BTCUSDT"?"BINANCE:BTCUSDT":"OANDA:XAUUSD";
 tv.src=`https://s.tradingview.com/widgetembed/?symbol=${sym}&interval=60&theme=dark&timezone=Etc/UTC`;
}
loadChart();

/* ================= WS BTC ================= */
let ws;
function connectWS(){
 if(ws)ws.close();
 ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+TF.map(t=>"btcusdt@kline_"+t).join("/"));
 ws.onmessage=e=>{
  let k=JSON.parse(e.data).data.k;
  if(!k.x)return;
  let tf=k.i,close=+k.c;
  let s=S.BTCUSDT;
  s.price=close;
  s.tf[tf].last=close;
  updateMission("BTCUSDT",tf);
  save();render();
 };
}
connectWS();
setInterval(()=>{if(!ws||ws.readyState>1)connectWS()},5000);

/* ================= ANCHOR ================= */
function setAnchor(){
 let O=+o.value,H=+h.value,L=+l.value,C=+c.value;
 let s=S[pairSel.value];
 if(H<Math.max(O,C)||L>Math.min(O,C)||H<=L||O===C){
  s.anchorState="INVALID";anchorState.textContent="ANCHOR INVALID";anchorState.className="bad";save();return;
 }
 s.anchor={O,H,L,C,t:Date.now()};
 s.offset=C-(s.price||C);
 s.anchorState="OK";
 anchorState.textContent="ANCHOR OK";anchorState.className="ok";
 save();render();
}

/* ================= MISSION ================= */
function updateMission(p,tf){
 let s=S[p],d=s.tf[tf];
 if(!d.last)return;
 let m=d.last+s.offset;
 if(!d.missions.includes(m))d.missions.push(m);
}
function missionStatus(m,price){
 if(Math.abs(m-price)<price*0.001)return "ACTIVE";
 if((m>price && m-price<price*0.01)||(m<price && price-m<price*0.01))return "WAITING";
 return "CONTEXT";
}
function renderMissions(){
 let s=S[pairSel.value],html="";
 TF.forEach(tf=>{
  let d=s.tf[tf];
  if(!d.missions.length){
   html+=`<tr><td>${tf}</td><td>-</td><td>-</td><td class="wait">WAIT</td></tr>`;
  }else d.missions.forEach((m,i)=>{
   let bias=m>(s.price+s.offset)?"BUY":"SELL";
   let st=missionStatus(m,s.price+s.offset);
   html+=`<tr><td>${i?"":tf}</td><td>${m.toFixed(2)}</td>
   <td class="${bias==="BUY"?"buy":"sell"}">${bias}</td>
   <td class="${st==="ACTIVE"?"active":st==="WAITING"?"wait":"ctx"}">${st}</td></tr>`;
  });
 });
 missions.innerHTML=html;
}

/* ================= OVERLAY ================= */
function clearOverlay(){overlay.innerHTML=""}
function drawMissionLines(){
 clearOverlay();
 let s=S[pairSel.value],price=s.price+s.offset;
 ["15m","30m","1h"].forEach(tf=>{
  s.tf[tf].missions.forEach(m=>{
   let y=50+(price-m)/price*100;
   let l=document.createElement("div");
   l.className="line";l.style.top=y+"%";
   overlay.appendChild(l);
  });
 });
}
function drawEntryZone(){
 let z=document.createElement("div");
 z.className="zone";z.style.top="40%";z.style.height="20%";
 overlay.appendChild(z);
}

/* ================= ASSIST ================= */
function ask(dir){
 let s=S[pairSel.value];
 if(s.anchorState!=="OK"){
  status.textContent="TUNGGU · ANCHOR";
  reason.textContent="Anchor H1 belum sehat. Semua entry ditahan.";
  clearOverlay();return;
 }
 status.textContent="GAS "+dir;
 reason.textContent=
`${dir} searah konteks.
Berlaku M1–M5 (eksekusi cepat).
M15–H1 sebagai penahan arah.
TP 1–2 candle.`;
 drawMissionLines();drawEntryZone();gasSound();
}

/* ================= UI ================= */
buy.onclick=()=>ask("BUY");
sell.onclick=()=>ask("SELL");
toggleReason.onclick=()=>reason.style.display=reason.style.display==="block"?"none":"block";
pairSel.onchange=()=>{loadChart();render()};
setAnchorBtn=document.getElementById("setAnchor");setAnchorBtn.onclick=setAnchor;

function render(){
 let s=S[pairSel.value];
 status.textContent=pairSel.value+" · "+s.anchorState;
 renderMissions();
}
function save(){localStorage.setItem(KEY,JSON.stringify(S))}
render();
</script>
</body>
</html>
