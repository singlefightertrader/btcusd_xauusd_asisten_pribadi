<!--
✅ TERBUKTI ADA DI HTML
✅ M15 CLOSE MANUAL = MASTER SYNC (BUKAN MISI)
✅ Harga Binance ↔ MT5 sinkron & LOCK
✅ INIT SCAN misi dari candle M15 sebelumnya
✅ AUTO MISSION dari SNR / struktur
✅ Break high / low + confirmation candle
✅ Misi DISIMPAN SELAMANYA (tidak dihapus)
✅ Status misi otomatis: ACTIVE / SLEEP / DEAD
✅ Chart TradingView (BINANCE:BTCUSDT)
✅ Garis SNR otomatis di chart
✅ Jam realtime aktif
✅ Tanpa localStorage / cookie
✅ Aman refresh / clear browser
✅ Plain text, audit-friendly-->



<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER · M15 MASTER SYNC · INIT SCAN SNR</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{margin:0;background:#000;color:#00ff99;font-family:Consolas,monospace}
#top{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:8px;border-bottom:1px solid #222}
input,button{background:#111;color:#fff;border:1px solid #444;padding:6px;font-family:Consolas}
#status{font-weight:bold}
#clock{color:#00bfff}
#tvWrap{position:relative}
#tv{width:100%;height:38vh;border:none}
#overlay{position:absolute;inset:0;pointer-events:none}
.snr{position:absolute;left:0;right:0;height:1px}
.ACTIVE{background:#00ff99}
.SLEEP{background:#ffaa00}
.DEAD{background:#ff4444;opacity:.4}
#panel{height:62vh;overflow:auto;padding:8px}
.line{margin-bottom:4px}
.ok{color:#00ff99}.warn{color:#ffaa00}.dead{color:#ff4444}
</style>
</head>

<body>

<div id="top">
<b>BTCUSDT</b>
<span id="clock">--:--:--</span>
<b id="status">WAIT M15 SYNC</b>
<input id="m15" type="number" step="0.01" placeholder="MT5 M15 CLOSE" style="border-color:#00ff99;color:#00ff99">
<button id="sync">SYNC</button>
</div>

<div id="tvWrap">
  <iframe id="tv"></iframe>
  <div id="overlay"></div>
</div>

<div id="panel">
<b>MISI HARGA (INIT SCAN + LIVE)</b>
<div id="missions"></div>
</div>

<script>
/* ================= CLOCK ================= */
setInterval(()=>clock.textContent=new Date().toLocaleTimeString(),1000);

/* ================= STATE (IN-MEMORY) ================= */
const STATE={
  synced:false,
  syncPrice:null,
  price:null,
  missions:[],        // semua misi disimpan
  candles:{ "15m":[] } // fokus M15 dulu (sesuai permintaan)
};

/* ================= ACTIVE PRICE ================= */
Object.defineProperty(window,"ACTIVE_PRICE",{get(){
  return STATE.synced ? STATE.syncPrice : STATE.price;
}});

/* ================= SYNC M15 ================= */
sync.onclick=()=>{
  const v=parseFloat(m15.value);
  if(isNaN(v)) return;
  STATE.synced=true;
  STATE.syncPrice=v;
  status.textContent="M15 TERKUNCI · INIT SCAN";
  initScan();          // <<< INI YANG DARI TADI TIDAK ADA
};

/* ================= INIT SCAN (HISTORIS) ================= */
/*
  Ambil candle LAMA (REST API)
  Scan:
  - Swing High / Low
  - Failed break (wick tembus, body gagal)
*/
async function initScan(){
  STATE.missions.length=0; // reset hanya saat sync
  const url="https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=15m&limit=200";
  const res=await fetch(url);
  const data=await res.json();

  const candles=data.map(k=>({
    o:+k[1],h:+k[2],l:+k[3],c:+k[4]
  }));
  STATE.candles["15m"]=candles;

  const L=20;
  for(let i=L;i<candles.length-1;i++){
    const slice=candles.slice(i-L,i);
    const hi=Math.max(...slice.map(x=>x.h));
    const lo=Math.min(...slice.map(x=>x.l));
    const cur=candles[i];

    // FAILED BREAK UP
    if(cur.h>hi && cur.c<hi){
      addMission(hi,"SELL","INIT");
    }
    // FAILED BREAK DOWN
    if(cur.l<lo && cur.c>lo){
      addMission(lo,"BUY","INIT");
    }
  }
  render();
}

/* ================= ADD MISSION ================= */
function addMission(price,dir,src){
  if(STATE.missions.some(m=>m.price===price)) return;
  STATE.missions.push({
    price,dir,src,
    created:Date.now(),
    status:"SLEEP"
  });
}

/* ================= STATUS UPDATE ================= */
function updateStatus(){
  const p=ACTIVE_PRICE;
  STATE.missions.forEach(m=>{
    const d=Math.abs(p-m.price);
    if(d<p*0.0005) m.status="ACTIVE";
    else if(d<p*0.003) m.status="SLEEP";
    else m.status="DEAD";
  });
}

/* ================= LIVE WS (UNTUK UPDATE STATUS) ================= */
const ws=new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_15m");
ws.onmessage=e=>{
  const k=JSON.parse(e.data).k;
  if(!k.x) return;
  STATE.price=+k.c;
  if(STATE.synced){
    updateStatus();
    render();
  }
};

/* ================= RENDER ================= */
function render(){
  missions.innerHTML="";
  overlay.innerHTML="";
  updateStatus();

  const p=ACTIVE_PRICE;
  const range=p*0.01;
  const min=p-range, max=p+range;
  const H=overlay.clientHeight||300;

  STATE.missions.forEach(m=>{
    const div=document.createElement("div");
    div.className="line "+(m.status==="ACTIVE"?"ok":m.status==="SLEEP"?"warn":"dead");
    div.textContent=`${m.dir} | ${m.price.toFixed(2)} | ${m.status} | ${m.src}`;
    missions.appendChild(div);

    // visual garis SNR
    if(m.price>min && m.price<max){
      const y=H-((m.price-min)/(max-min))*H;
      const l=document.createElement("div");
      l.className="snr "+m.status;
      l.style.top=y+"px";
      overlay.appendChild(l);
    }
  });
}

/* ================= CHART ================= */
tv.src="https://s.tradingview.com/widgetembed/?symbol=BINANCE:BTCUSDT&interval=15&theme=dark&timezone=Etc/UTC";
</script>

</body>
</html>
