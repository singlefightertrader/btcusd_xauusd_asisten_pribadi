<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER ASSISTANT Â· M15 MANUAL LOCK (NO STORAGE)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{margin:0;background:#000;color:#00ff99;font-family:Consolas,monospace}
#top{padding:8px;border-bottom:1px solid #222;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,button{background:#111;color:#fff;border:1px solid #444;padding:6px;font-family:Consolas}
#status{font-weight:bold}
#tv{width:100%;height:38vh;border:none}
#panel{height:62vh;overflow:auto;padding:8px}
.section{border:1px solid #333;margin-bottom:8px;padding:8px;background:#070707}
.ctx{white-space:pre-line}
.ok{color:#00ff99}
.warn{color:#ffaa00}
.lock{color:#00ff99;font-weight:bold}
</style>
</head>

<body>

<div id="top">
<b>PAIR</b>
<span>BTCUSDT</span>
<b id="status">WAIT M15</b>

<input id="m15close" type="number" step="0.01"
placeholder="INPUT M15 CLOSE"
style="width:160px;border:1px solid #00ff99;color:#00ff99">

<button id="lockBtn">LOCK M15</button>
<span id="lockInfo" class="warn">M15 BELUM DISET</span>
</div>

<iframe id="tv"></iframe>

<div id="panel">
<div class="section">
<b>MISSION STATUS</b>
<div id="mission" class="ctx"></div>
</div>
</div>

<script>
/* =========================================================
   KONTRAK INTI
   - Binance = bentuk candle (visual)
   - M15 CLOSE manual = harga keputusan
   - TIDAK pakai localStorage
   - Refresh / clear data = input ulang (DISENGAJA)
   ========================================================= */

const TF=["1m","5m","15m"];
let STATE={
  price:null,
  tf:{}
};
TF.forEach(tf=>STATE.tf[tf]={last:null,prev:null,missions:[]});

/* ================= M15 LOCK ================= */
const M15={
  active:false,
  price:null,
  time:null
};

document.getElementById("lockBtn").onclick=()=>{
  const v=parseFloat(document.getElementById("m15close").value);
  if(isNaN(v)) return;
  M15.active=true;
  M15.price=v;
  M15.time=Date.now();
  document.getElementById("status").textContent="RUNNING Â· M15 LOCK";
  updateLockInfo();
};

function updateLockInfo(){
  if(!M15.active){
    lockInfo.textContent="M15 BELUM DISET";
    lockInfo.className="warn";
    return;
  }
  const mins=Math.floor((Date.now()-M15.time)/60000);
  lockInfo.textContent=`ðŸ”’ M15 TERKUNCI â€“ ${mins} menit lewat (AMAN)`;
  lockInfo.className="lock";
}
setInterval(updateLockInfo,30000);

/* ================= HARGA AKTIF ================= */
Object.defineProperty(window,"ACTIVE_PRICE",{
  get(){
    if(M15.active) return M15.price;
    return STATE.price;
  }
});

/* ================= MISSION ENGINE ================= */
function createMission(tf){
  const d=STATE.tf[tf];
  if(d.prev===null || !M15.active) return;
  const price=ACTIVE_PRICE;
  if(d.missions.some(m=>m.price===price)) return;
  d.missions.push({
    price,
    role:tf==="1m"?"TARGET":"CONTEXT",
    status:"ACTIVE"
  });
}
function updateMissions(tf){
  const d=STATE.tf[tf];
  const close=ACTIVE_PRICE;
  d.missions.forEach(m=>{
    if(m.status==="CONSUMED")return;
    if(close===m.price)m.status="CONSUMED";
    else if(m.role==="CONTEXT")m.status="CONTEXT";
    else m.status="WAITING";
  });
}

/* ================= BINANCE WS ================= */
let ws;
function connect(){
  ws=new WebSocket(
    "wss://stream.binance.com:9443/stream?streams="+
    TF.map(t=>"btcusdt@kline_"+t).join("/")
  );
  ws.onmessage=e=>{
    const k=JSON.parse(e.data).data.k;
    if(!k.x) return;

    const tf=k.i;
    const d=STATE.tf[tf];
    d.prev=d.last;
    d.last=+k.c;
    STATE.price=+k.c;

    createMission(tf);
    updateMissions(tf);
    render();
  };
}
connect();

/* ================= UI ================= */
function render(){
  let out=[];
  TF.forEach(tf=>{
    STATE.tf[tf].missions.forEach(m=>{
      out.push(`${tf} | ${m.price} | ${m.status}`);
    });
  });
  mission.textContent=out.join("\n");
}

/* ================= CHART ================= */
tv.src="https://s.tradingview.com/widgetembed/?symbol=BINANCE:BTCUSDT&interval=15&theme=dark&timezone=Etc/UTC";
</script>

</body>
</html>
