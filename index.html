<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER ASSISTANT · FINAL</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
body{margin:0;background:#000;color:#00ff99;font-family:Consolas,monospace}
#top{padding:8px;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center}
select,button,input{background:#111;color:#fff;border:1px solid #444;padding:6px;font-family:Consolas}
#status{font-weight:bold}
#tvWrap{position:relative}
#tv{width:100%;height:38vh;border:none}
#panel{height:62vh;overflow:auto;padding:8px}
.section{border:1px solid #333;margin-bottom:8px;padding:8px;background:#070707}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border-bottom:1px solid #222;padding:4px}
#reason{display:none;border-left:4px solid #ffaa00;padding:8px;white-space:pre-line}
.zone{background:rgba(0,255,255,.15);border:1px solid rgba(0,255,255,.6);height:36px;margin-top:6px}
.ctx{color:#aaa}.warn{color:#ffaa00}.ok{color:#00ff99}
.standby{animation:blink 1.2s infinite;border:2px solid #ffaa00}
.gas{border:2px solid #00ff99}
.late{border:2px solid #ff4444}
@keyframes blink{50%{box-shadow:0 0 10px rgba(255,170,0,.6)}}
</style>
</head>

<body>

<div id="top">
<b>PAIR</b>
<select id="pair">
<option>BTCUSDT</option>
<option>XAUUSD</option>
</select>
<b id="status">BOOT</b>
<button id="toggleReason">SHOW</button>
</div>

<div id="tvWrap">
<iframe id="tv"></iframe>
</div>

<div id="panel">

<div class="section">
<b>ANCHOR H1 · OHLC MANUAL</b><br>
O <input id="o" size="7">
H <input id="h" size="7">
L <input id="l" size="7">
C <input id="c" size="7">
<button id="setAnchor">SET</button>
</div>

<div class="section">
<b>MISSION ENGINE</b>
<table>
<thead><tr><th>TF</th><th>Mission</th><th>Role</th><th>Status</th></tr></thead>
<tbody id="missionTable"></tbody>
</table>
</div>

<div id="decisionBox" class="section">
<button id="buy">BUY</button>
<button id="sell">SELL</button>
<div id="entryZone"></div>
<div id="tpContext" class="ctx"></div>
</div>

<div id="reason"></div>
</div>

<script>
/* ================= CORE STATE ================= */
const TF=["1m","5m","15m","30m","1h"];
const KEY="SCALPER_FINAL_STATE_V2";
let STATE=JSON.parse(localStorage.getItem(KEY)||"{}");
function init(){return{price:null,anchor:null,anchorState:"NONE",tf:{}}}
if(!STATE.BTCUSDT)STATE.BTCUSDT=init();
if(!STATE.XAUUSD)STATE.XAUUSD=init();
TF.forEach(tf=>{
["BTCUSDT","XAUUSD"].forEach(p=>{
if(!STATE[p].tf[tf])STATE[p].tf[tf]={prev:null,last:null,missions:[]};
});
});
function save(){localStorage.setItem(KEY,JSON.stringify(STATE))}

/* ================= ANCHOR ================= */
const MAX=1000*60*60*4;
function updateAnchor(p){
if(!p.anchor){p.anchorState="NONE";return}
let age=Date.now()-p.anchor.t;
if(p.anchor.bad)p.anchorState="INVALID";
else if(age>MAX)p.anchorState="EXPIRED";
else if(age>MAX*0.6)p.anchorState="SUSPECT";
else p.anchorState="OK";
}

/* ================= MISSIONS ================= */
function createMission(d){
if(d.prev===null)return;
d.missions.push({price:d.prev,role:["15m","30m","1h"].includes(d.tf)?"CONTEXT":"TARGET",status:"ACTIVE"});
}
function updateMission(d,close){
d.missions.forEach(m=>{
if(m.status==="ACTIVE"){
if(close===m.price)m.status="CONSUMED";
else if(m.role==="CONTEXT")m.status="CONTEXT";
else m.status="WAITING";
}
});
d.missions=d.missions.filter(m=>m.status!=="CONSUMED");
}

/* ================= BTC WS ================= */
let ws;
function connect(){
if(ws)ws.close();
ws=new WebSocket("wss://stream.binance.com:9443/stream?streams="+TF.map(t=>"btcusdt@kline_"+t).join("/"));
ws.onmessage=e=>{
let k=JSON.parse(e.data).data.k;if(!k.x)return;
let p=STATE.BTCUSDT,d=p.tf[k.i];
d.tf=k.i; d.prev=d.last; d.last=+k.c; p.price=+k.c;
createMission(d); updateMission(d,+k.c); updateAnchor(p);
save(); render();
};
}
connect(); setInterval(()=>{if(!ws||ws.readyState>1)connect()},5000);

/* ================= XAU LOOP ================= */
setInterval(()=>{
let p=STATE.XAUUSD;if(!p.anchor)return;
TF.forEach(tf=>{
let d=p.tf[tf]; d.tf=tf; d.prev=d.last; d.last=p.anchor.C;
createMission(d); updateMission(d,p.anchor.C);
});
p.price=p.anchor.C; updateAnchor(p); save(); render();
},60000);

/* ================= DECISION + TP CONTEXT CHECK ================= */
function decisionState(p){
let m1=p.tf["1m"].missions[0], m5=p.tf["5m"].missions[0];
if(!m1||!m5)return"WAIT";
let min=Math.min(m1.price,m5.price), max=Math.max(m1.price,m5.price);
if(p.price>min&&p.price<max)return"GAS";
if(Math.abs(p.price-(min+max)/2)<(max-min)*2)return"STANDBY";
return"LATE";
}

function tpContextCheck(p,dir){
let m15=p.tf["15m"].missions[0];
let h1=p.tf["1h"].missions[0];
if(!m15||!h1)return{mode:"SCALP",msg:"TF besar belum lengkap."};

let bias15=m15.price>p.price?"SELL":"BUY";
let biasH1=h1.price>p.price?"SELL":"BUY";

if(bias15===dir && biasH1===dir){
return{
mode:"CONTEXT",
msg:
"TF besar mendukung.\n"+
"M15 belum ada close pembalikan.\n"+
"H1 masih pegang struktur.\n"+
"Boleh tahan sampai M15 candle ke-2."
};
}
return{
mode:"SCALP",
msg:
"TF besar belum sepenuhnya mendukung.\n"+
"Disarankan TP cepat 1–2 candle."
};
}

function decide(dir){
let p=STATE[pair.value]; updateAnchor(p);
decisionBox.className="section";
tpContext.textContent="";

if(p.anchorState!=="OK"){
status.textContent="WAIT · ANCHOR";
return;
}

let state=decisionState(p);
decisionBox.classList.add(
state==="STANDBY"?"standby":
state==="GAS"?"gas":
state==="LATE"?"late":""
);

if(state==="STANDBY"){
status.textContent="SIAP "+dir;
return;
}
if(state==="LATE"){
status.textContent="TERLAMBAT";
return;
}
if(state==="GAS"){
status.textContent="GAS "+dir;
let ctx=tpContextCheck(p,dir);
tpContext.textContent=
(ctx.mode==="CONTEXT"?"GAS "+dir+" · CONTEXT KUAT\n":"GAS "+dir+" (SCALP)\n")
+ctx.msg;
gasSound();
}
}

/* ================= SOUND ================= */
const AC=new(window.AudioContext||window.webkitAudioContext)();
function gasSound(){
let i=0,t=setInterval(()=>{
let o=AC.createOscillator(),g=AC.createGain();
o.frequency.value=1000; g.gain.value=.08;
o.connect(g); g.connect(AC.destination);
o.start(); o.stop(AC.currentTime+.12);
if(++i===4)clearInterval(t);
},180);
}

/* ================= UI ================= */
const pair=document.getElementById("pair");
const status=document.getElementById("status");
const missionTable=document.getElementById("missionTable");
const decisionBox=document.getElementById("decisionBox");
const tpContext=document.getElementById("tpContext");

function render(){
let p=STATE[pair.value];
status.textContent=pair.value+" · "+p.anchorState;
let html="";
TF.forEach(tf=>{
let d=p.tf[tf];
if(!d.missions.length)
html+=`<tr><td>${tf}</td><td>-</td><td>-</td><td>-</td></tr>`;
else d.missions.forEach(m=>{
html+=`<tr><td>${tf}</td><td>${m.price.toFixed(2)}</td><td>${m.role}</td><td>${m.status}</td></tr>`;
});
});
missionTable.innerHTML=html;
}

document.getElementById("setAnchor").onclick=()=>{
let O=+o.value,H=+h.value,L=+l.value,C=+c.value;
let p=STATE[pair.value];
if(H<Math.max(O,C)||L>Math.min(O,C)||O===C)p.anchor={bad:true,t:Date.now()};
else p.anchor={O,H,L,C,t:Date.now()};
updateAnchor(p); save(); render();
};

document.getElementById("buy").onclick=()=>decide("BUY");
document.getElementById("sell").onclick=()=>decide("SELL");
document.getElementById("toggleReason").onclick=()=>{
reason.style.display=reason.style.display==="block"?"none":"block";
};

function loadChart(){
let sym=pair.value==="BTCUSDT"?"BINANCE:BTCUSDT":"OANDA:XAUUSD";
tv.src=`https://s.tradingview.com/widgetembed/?symbol=${sym}&interval=60&theme=dark&timezone=Etc/UTC`;
}
pair.onchange=()=>{loadChart();render();};
loadChart(); render();
</script>

</body>
</html>
