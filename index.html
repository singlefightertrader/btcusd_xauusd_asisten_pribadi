<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SCALPER ASSISTANT · CONTRACT SAFE A++</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
body{margin:0;background:#000;color:#00ff99;font-family:Consolas,monospace}
#top{padding:8px;border-bottom:1px solid #222;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,button,input{background:#111;color:#fff;border:1px solid #444;padding:6px;font-family:Consolas}
button.active{background:#003322;border-color:#00ff99}
button.early{border-color:#00ff99}
button.standby{border-color:#ffaa00}
button.late{border-color:#ff4444}
#status{font-weight:bold}
#mode{color:#ffaa00;font-weight:bold}
#session{color:#00bfff;font-weight:bold}
#tvWrap{position:relative}
#tv{width:100%;height:38vh;border:none}
#overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none}
.line{position:absolute;left:0;right:0;height:1px}
.line.m15{background:#ffff00}
.line.m30{background:#00bfff}
.line.h1{background:#bf00ff}
#panel{height:62vh;overflow:auto;padding:8px}
.section{border:1px solid #333;margin-bottom:8px;padding:8px;background:#070707}
.zone{margin-top:6px;padding:6px;border:1px dashed #00ffff;color:#00ffff}
.warn{color:#ff4444}
.info{color:#ffaa00}
.ok{color:#00ff99}
.ctx{white-space:pre-line}
.hidden{display:none}
.score{margin-top:4px}
</style>
</head>

<body>

<div id="top">
<b>PAIR</b>
<select id="pair">
<option>BTCUSDT</option>
<option>XAUUSD</option>
</select>
<span id="mode">MODE: SNIPER</span>
<span id="session">SESSION: -</span>
<b id="status">BOOT</b>
<button id="toggleReason">SHOW</button>
</div>

<div id="tvWrap">
<iframe id="tv"></iframe>
<div id="overlay"></div>
</div>

<div id="panel">

<div class="section">
<b>ANCHOR H1 · MANUAL OHLC</b><br>
O <input id="o" size="7">
H <input id="h" size="7">
L <input id="l" size="7">
C <input id="c" size="7">
<button id="setAnchor">SET</button>
<div id="anchorState"></div>
</div>

<div class="section">
<b>MISSION / CONTEXT</b>
<div id="missionState" class="ctx"></div>
<div id="priorityTarget" class="info"></div>
<div id="strength" class="score"></div>
</div>

<div class="section">
<b>DECISION</b><br>
<button id="buy">BUY</button>
<button id="sell">SELL</button>
<div id="entryZone" class="zone hidden"></div>
<div id="lateWarning" class="warn hidden">RISIKO FLOATING BESAR</div>
<div id="cooldown" class="info hidden">COOLDOWN AKTIF</div>
</div>

<div id="reason" class="ctx hidden"></div>

</div>

<script>
/* ================= CORE ================= */
const TF=["1m","5m","15m","30m","1h"];
const KEY="SCALPER_CONTRACT_A_PP";
let STATE=JSON.parse(localStorage.getItem(KEY)||"{}");

function init(){
 return{
  price:null,
  anchor:null,
  anchorState:"NONE",
  cooldownUntil:0,
  tf:{}
 };
}

["BTCUSDT","XAUUSD"].forEach(p=>{
 if(!STATE[p])STATE[p]=init();
 TF.forEach(tf=>{
  if(!STATE[p].tf[tf])
   STATE[p].tf[tf]={last:null,prev:null,missions:[]};
 });
});

function save(){localStorage.setItem(KEY,JSON.stringify(STATE))}

/* ================= ANCHOR ================= */
const MAX=1000*60*60*4;
function updateAnchor(p){
 if(!p.anchor){p.anchorState="NONE";return}
 let age=Date.now()-p.anchor.t;
 if(p.anchor.bad)p.anchorState="INVALID";
 else if(age>MAX)p.anchorState="EXPIRED";
 else if(age>MAX*0.6)p.anchorState="SUSPECT";
 else p.anchorState="OK";
}

/* ================= MISSION ENGINE ================= */
function createMission(d){
 if(d.prev===null)return;
 let price=d.prev;
 if(d.missions.some(m=>m.price===price))return;
 d.missions.push({
  price,
  role:["15m","30m","1h"].includes(d.tf)?"CONTEXT":"TARGET",
  status:"ACTIVE",
  t:Date.now()
 });
}

function updateMissions(d,close){
 d.missions.forEach(m=>{
  if(m.status==="CONSUMED")return;
  if(close===m.price){
   m.status="CONSUMED";
  }else if(m.role==="CONTEXT"){
   m.status="CONTEXT";
  }else{
   m.status="WAITING";
  }
 });
}

/* ================= CONTEXT LEVELS ================= */
function contextLevels(p){
 let levels=[];
 ["15m","30m","1h"].forEach(tf=>{
  p.tf[tf].missions.forEach(m=>{
   if(m.status==="CONTEXT")levels.push(m.price);
  });
 });
 return levels.sort((a,b)=>a-b);
}

function contextBreached(p,close){
 let lv=contextLevels(p);
 if(!lv.length)return false;
 return close<lv[0] || close>lv[lv.length-1];
}

/* ================= CONTEXT STRENGTH ================= */
function contextStrength(p){
 let score=0;
 let lv=contextLevels(p);
 if(lv.length>=3)score+=40;
 else if(lv.length===2)score+=25;
 else if(lv.length===1)score+=10;

 if(p.anchorState==="OK")score+=20;
 if(!contextBreached(p,p.price))score+=20;
 if(!inCooldown(p))score+=10;

 return Math.min(100,score);
}

/* ================= SESSION ================= */
function getSession(){
 let h=new Date().getUTCHours();
 if(h>=0 && h<7) return "ASIA";
 if(h>=7 && h<13) return "LONDON";
 if(h>=13 && h<21) return "NEW YORK";
 return "OFF";
}

/* ================= BTC WS ================= */
let ws;
function connect(){
 ws=new WebSocket(
  "wss://stream.binance.com:9443/stream?streams="+
  TF.map(t=>"btcusdt@kline_"+t).join("/")
 );
 ws.onmessage=e=>{
  let k=JSON.parse(e.data).data.k;
  if(!k.x)return;
  let p=STATE.BTCUSDT;
  let d=p.tf[k.i];
  d.tf=k.i;
  d.prev=d.last;
  d.last=+k.c;
  p.price=+k.c;
  createMission(d);
  updateMissions(d,+k.c);
  updateAnchor(p);
  save();render();
 };
}
connect();
setInterval(()=>{if(!ws||ws.readyState>1)connect()},5000);

/* ================= XAU LOOP ================= */
setInterval(()=>{
 let p=STATE.XAUUSD;
 if(!p.anchor)return;
 TF.forEach(tf=>{
  let d=p.tf[tf];
  d.tf=tf;
  d.prev=d.last;
  d.last=p.anchor.C;
  createMission(d);
  updateMissions(d,p.anchor.C);
 });
 p.price=p.anchor.C;
 updateAnchor(p);
 save();render();
},60000);

/* ================= DECISION ================= */
function inCooldown(p){return Date.now()<p.cooldownUntil}

function timingLabel(p){
 let lv=contextLevels(p);
 if(!lv.length)return "STANDBY";
 if(contextBreached(p,p.price))return "LATE";
 return "EARLY";
}

function decide(dir){
 let p=STATE[pair.value];
 updateAnchor(p);
 buy.className=""; sell.className="";

 if(p.anchorState!=="OK"){
  status.textContent="WAIT · ANCHOR "+p.anchorState;
  return;
 }

 let timing=timingLabel(p);
 (dir==="BUY"?buy:sell).classList.add(timing.toLowerCase());

 if(timing==="LATE"){
  status.textContent="LATE "+dir;
  lateWarning.classList.remove("hidden");
  return;
 }

 if(inCooldown(p)){
  status.textContent="COOLDOWN";
  cooldown.classList.remove("hidden");
  return;
 }

 status.textContent="GAS "+dir+" · "+timing;
 (dir==="BUY"?buy:sell).classList.add("active");
 p.cooldownUntil=Date.now()+60000;

 entryZone.textContent="ENTRY IDEAL: M1–M5 ("+p.price+")";
 entryZone.classList.remove("hidden");

 reason.textContent=
  "TIMING: "+timing+"\n"+
  "SESSION: "+getSession()+"\n"+
  "EKSEKUSI SESUAI KONTEKS";

 gasSound();
 save();render();
}

/* ================= SOUND ================= */
const AC=new(window.AudioContext||window.webkitAudioContext)();
function gasSound(){
 let i=0,t=setInterval(()=>{
  let o=AC.createOscillator(),g=AC.createGain();
  o.frequency.value=1000;g.gain.value=.08;
  o.connect(g);g.connect(AC.destination);
  o.start();o.stop(AC.currentTime+.12);
  if(++i===4)clearInterval(t);
 },180);
}

/* ================= MISSION LINES ================= */
function renderLines(){
 overlay.innerHTML="";
 let p=STATE[pair.value];
 if(!p.price)return;
 let h=overlay.clientHeight;
 ["15m","30m","1h"].forEach(tf=>{
  p.tf[tf].missions.forEach(m=>{
   if(m.status!=="CONTEXT")return;
   let y=h/2-(m.price-p.price)/(p.price*0.01)*h/2;
   let div=document.createElement("div");
   div.className="line "+(tf==="15m"?"m15":tf==="30m"?"m30":"h1");
   div.style.top=y+"px";
   overlay.appendChild(div);
  });
 });
}

/* ================= UI ================= */
const pair=document.getElementById("pair");
const status=document.getElementById("status");
const mode=document.getElementById("mode");
const session=document.getElementById("session");
const anchorState=document.getElementById("anchorState");
const missionState=document.getElementById("missionState");
const priorityTarget=document.getElementById("priorityTarget");
const strength=document.getElementById("strength");
const entryZone=document.getElementById("entryZone");
const lateWarning=document.getElementById("lateWarning");
const cooldown=document.getElementById("cooldown");
const reason=document.getElementById("reason");
const buy=document.getElementById("buy");
const sell=document.getElementById("sell");
const overlay=document.getElementById("overlay");

function render(){
 let p=STATE[pair.value];
 updateAnchor(p);
 mode.textContent="MODE: SNIPER";
 session.textContent="SESSION: "+getSession();
 anchorState.textContent="ANCHOR: "+p.anchorState;

 let s=contextStrength(p);
 strength.textContent=
  "STRENGTH: "+s+"/100 "+
  (s>=70?"(STRONG)":s>=40?"(MODERATE)":"(WEAK)");

 let lines=[];
 TF.forEach(tf=>{
  p.tf[tf].missions.forEach(m=>{
   lines.push(tf+" "+m.price+" "+m.status);
  });
 });
 missionState.textContent=lines.join("\n");

 if(!inCooldown(p))cooldown.classList.add("hidden");
 renderLines();
}

document.getElementById("setAnchor").onclick=()=>{
 let O=+o.value,H=+h.value,L=+l.value,C=+c.value;
 let p=STATE[pair.value];
 if(H<Math.max(O,C)||L>Math.min(O,C)||O===C)
  p.anchor={bad:true,t:Date.now()};
 else p.anchor={O,H,L,C,t:Date.now()};
 updateAnchor(p);
 save();render();
};

buy.onclick=()=>decide("BUY");
sell.onclick=()=>decide("SELL");
toggleReason.onclick=()=>reason.classList.toggle("hidden");

function loadChart(){
 let sym=pair.value==="BTCUSDT"?"BINANCE:BTCUSDT":"OANDA:XAUUSD";
 tv.src=`https://s.tradingview.com/widgetembed/?symbol=${sym}&interval=60&theme=dark&timezone=Etc/UTC`;
}
pair.onchange=()=>{loadChart();render()};
loadChart();render();
</script>

</body>
</html>
